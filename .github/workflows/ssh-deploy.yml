name: Deploy Flask App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Fix line endings in hosts.txt
        run: sed -i 's/\r$//' hosts.txt
      - name: Deploy to servers
        run: |
          while IFS=" " read -r host pem_file; do
            echo "ðŸ”‘ Copying PEM file for $host"
            chmod 600 pem_files/$pem_file

            echo "ðŸ“¦ Copying project files to $host..."
            rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/

            echo "ðŸš€ Starting Flask app on $host..."
            ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no ubuntu@$host "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"

            echo "âœ… Flask started on http://$host:5000"
          done < hosts.txt
