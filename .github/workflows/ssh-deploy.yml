name: Deploy Flask App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Fix line endings in hosts.txt
        run: sed -i 's/\r$//' hosts.txt
      - name: Deploy to servers
        run: |
            sed -i 's/\r$//' hosts.csv

            tail -n +2 hosts.csv | while IFS=, read -r host pem_file; do
            host=$(echo "$host" | xargs)
            pem_file=$(echo "$pem_file" | xargs)

            echo "---------------------------"
            echo "Processing: HOST=$host  PEM=$pem_file"
            echo "---------------------------"

            if [ ! -f "pem_files/$pem_file" ]; then
                echo "âŒ ERROR: PEM file not found for $host (pem_files/$pem_file)"
                continue   # skip this host but continue with others
            fi

            chmod 600 "pem_files/$pem_file" || {
                echo "âš ï¸ chmod failed for $pem_file"
                continue
            }

            echo "ðŸ“¦ Rsync to $host..."
            if ! rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/; then
                echo "âŒ Rsync failed for $host"
                continue
            fi

            echo "ðŸš€ Starting Flask app on $host..."
            if ! ssh -i "pem_files/$pem_file" -o StrictHostKeyChecking=no ubuntu@"$host" \
                "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"; then
                echo "âŒ SSH failed for $host"
                continue
            fi

            echo "âœ… Done with $host"
            done



    #   - name: Deploy to servers
    #     run: |
    #         # Remove CRLF if present (in case CSV came from Windows)
    #         sed -i 's/\r$//' hosts.csv

    #         tail -n +2 hosts.csv | while IFS=, read -r host pem_file; do
    #         echo "ðŸ”‘ Copying PEM file for $host"
    #         chmod 600 pem_files/$pem_file

    #         echo "ðŸ“¦ Copying project files to $host..."
    #         rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/

    #         echo "ðŸš€ Starting Flask app on $host..."
    #         ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no ubuntu@$host "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"

    #         echo "âœ… Flask started on http://$host:5000"
    #         done

    #   - name: Deploy to servers
    #     run: |
    #       while IFS=" " read -r host pem_file; do
    #         echo "ðŸ”‘ Copying PEM file for $host"
    #         chmod 600 pem_files/$pem_file

    #         echo "ðŸ“¦ Copying project files to $host..."
    #         rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/

    #         echo "ðŸš€ Starting Flask app on $host..."
    #         ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no ubuntu@$host "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"

    #         echo "âœ… Flask started on http://$host:5000"
    #       done < hosts.txt
