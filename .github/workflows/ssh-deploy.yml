name: Deploy Flask App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Fix line endings in hosts.txt
        run: sed -i 's/\r$//' hosts.txt
      # - name: Deploy to servers
      #   run: |
      #       sed -i 's/\r$//' hosts.csv
      #       while IFS="," read -r host pem_file; do
      #       [[ "$host" == "host" ]] && continue   # skip CSV header

      #       echo "---------------------------"
      #       echo "Processing: HOST=$host  PEM=$pem_file"
      #       echo "---------------------------"

      #       # Ensure correct permissions
      #       chmod 600 "pem_files/$pem_file" 2>/dev/null || true

      #       # Rsync with error handling
      #       if rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/; then
      #           echo "ğŸ“¦ Rsync to $host succeeded."
      #       else
      #           echo "âŒ Rsync failed for $host"
      #           continue   # go to next host instead of stopping
      #       fi

      #       # Start Flask app (wonâ€™t run if rsync failed)
      #       if ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no ubuntu@$host \
      #           "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"; then
      #           echo "ğŸš€ Flask started on $host"
      #       else
      #           echo "âŒ Failed to start Flask on $host"
      #       fi

      #       echo "âœ… Done with $host"
      #       done < hosts.csv





    #   - name: Deploy to servers
    #     run: |
    #         # Remove CRLF if present (in case CSV came from Windows)
    #         sed -i 's/\r$//' hosts.csv

    #         tail -n +2 hosts.csv | while IFS=, read -r host pem_file; do
    #         echo "ğŸ”‘ Copying PEM file for $host"
    #         chmod 600 pem_files/$pem_file

    #         echo "ğŸ“¦ Copying project files to $host..."
    #         rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/

    #         echo "ğŸš€ Starting Flask app on $host..."
    #         ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no ubuntu@$host "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"

    #         echo "âœ… Flask started on http://$host:5000"
    #         done

      - name: Deploy to servers
        run: |
          while IFS=" " read -r host pem_file; do
            echo "ğŸ”‘ Copying PEM file for $host"
            chmod 600 pem_files/$pem_file

            echo "ğŸ“¦ Copying project files to $host..."
            rsync -avz -e "ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no" ./src/ ubuntu@$host:/home/ubuntu/app/

            echo "ğŸš€ Starting Flask app on $host..."
            ssh -i pem_files/$pem_file -o StrictHostKeyChecking=no ubuntu@$host "cd /home/ubuntu/app && nohup python3 zbx.py > flask.log 2>&1 &"

            echo "âœ… Flask started on http://$host:5000"
          done < hosts.txt
